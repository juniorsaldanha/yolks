name: Build and Push Images

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  list-games:
    runs-on: ubuntu-latest
    outputs:
      games: ${{ steps.list-games.outputs.games }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: List games with Dockerfiles
      id: list-games
      run: |
        GAMES=()
        for d in games/*/; do
          if [[ -f "$d/Dockerfile" ]]; then
            GAMES+=("$(basename "$d")")
          fi
        done
        GAMES_JSON=$(printf '%s' "${GAMES[@]}" | jq -Rs 'split("\n") | map(select(length > 0))')
        echo "games=$GAMES_JSON" >> $GITHUB_OUTPUT
        echo "Found games: $GAMES_JSON"

  build-and-push:
    needs: list-games
    if: >-
      needs.list-games.outputs.games != '[]' &&
      github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        game: ${{ fromJson(needs.list-games.outputs.games) }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Docker meta
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}/${{ matrix.game }}
        flavor: |
          latest,staging=auto
        tags: |
          type=ref,event=branch
          type=ref,event=tag
          type=sha

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: ./games/${{ matrix.game }}
        file: ./games/${{ matrix.game }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Inspect image
      if: always()
      run: |
        docker buildx imagetools inspect ${{ steps.meta.outputs.tags }}